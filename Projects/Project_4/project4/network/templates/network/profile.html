{% extends "network/layout.html" %}



{% block body %}
    <div id="app"></div>

    <script type="text/babel">
        
        function App() {

            let buttonValue = ""
                if ( {{ is_following }} ) {
                    buttonValue = "Unfollow"
                }
                else {
                    buttonValue = "Follow"
                }

            const [buttonState, setButtonState] = React.useState({
                buttonText: buttonValue, 
                viewedUserFollowers: {{ profile.followers.all | length }}
            });

            function handleButtonClick() {
                if (buttonState.buttonText === "Follow") {
                    setButtonState({
                        buttonText: "Unfollow",
                        viewedUserFollowers: buttonState.viewedUserFollowers + 1 
                    });
                }
                else {
                    setButtonState({
                        buttonText: "Follow",
                        viewedUserFollowers: buttonState.viewedUserFollowers - 1 
                    });
                }
            };

            window.onunload = async function() {
                let condition = ""
                if (buttonState.buttonText === "Follow"){
                    condition = "Unfollow"
                }
                else {
                    condition = "Follow"
                }

                console.log("LEFT THE PAGE")
                await fetch('/follow', {
                    method: 'POST',
                    body: JSON.stringify({
                        mainuser: "{{ request.user.username }}",
                        targetuser: "{{ profile.user }}",
                        status: condition
                    })
                })
                .then(response => response.json())
                .then(result => {
                    console.log(result.message);
                    location.reload()
                })
            };

            return (
                <div>
                    <div id="newpost">
                        <h1>{{ user.username }}'s Profile</h1>
                        <h4>Followers: { buttonState.viewedUserFollowers }</h4>
                        <h4>Following: {{ profile.followings.all | length }}</h4>
                        {% if request.user.is_authenticated and user != request.user %}
                            <input class="btn btn-primary" type="submit" onClick={ handleButtonClick } value={ buttonState.buttonText }/>
                        {% endif %}
                    </div>
                    <br/>
                    <h2>{{ user.username }}'s Posts</h2>

                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            {% if posts.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ posts.previous_page_number }}">Previous</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">Previous</a>
                                </li>
                            {% endif %}
                            {% for page_num in posts.paginator.page_range %}
                                <li class="page-item {% if page_num == posts.number %}active{% endif %}">
                                    <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                </li>
                            {% endfor %}
                            {% if posts.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ posts.next_page_number }}">Next</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    
                    {% for post in posts %}
                        <div id="newpost">
                            <a href="/users/{{ post.poster }}"><h3><b>{{ post.poster }}</b></h3></a>
                            <h4>{{ post.content }}</h4>
                            <h6>{{ post.time }}</h6>
                            <h6>{{ post.likers.all | length }}</h6>
                        </div>
                    {% empty %}
                        <div>
                            <h2>{{ user.username }} Has Not Made Any Posts</h2>
                        </div>
                    {% endfor %}
                </div>
            );
        }
    
        ReactDOM.render(<App />,  document.querySelector("#app"));
    
    </script>
{% endblock %}



